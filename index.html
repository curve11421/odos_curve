<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODOS Student Management System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #FEFDF7;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        .header {
            background-color: #F8D442;
            padding: 15px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 { margin: 0; font-size: 24px; color: #333; }
        .header p { margin: 5px 0 0; font-size: 16px; }
        .card {
            background-color: #FFFFFF;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
            margin-bottom: 20px;
        }
        .search-students {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: flex-end;
        }
        .search-students .form-group { display: flex; flex-direction: column; }
        .search-students label { margin-bottom: 8px; font-weight: bold; }
        .search-students input { padding: 10px; border: 1px solid #CCC; border-radius: 4px; font-size: 16px; }
        .button-group { display: flex; gap: 10px; padding-top: 28px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; font-weight: bold; }
        .btn-add { background-color: #F8D442; color: #333; }
        .btn-clear { background-color: #E0E0E0; color: #333; }
        .btn-approve-all { background-color: #4CAF50; color: white; float: right; margin-bottom: 10px; }
        .loading, .message { text-align: center; padding: 20px; font-size: 18px; }

        /* Styles for Multiple Student Cards */
        .student-list-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }
        .student-card-wrapper { flex-shrink: 0; }
        .student-card {
            width: 320px; padding: 20px; background-color: #FEFDF7;
            border: 1px solid #E0E0E0; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center;
        }
        .student-card .profile-pic img {
            width: 100px; height: 100px; border-radius: 50%;
            object-fit: cover; border: 2px solid #F8D442; margin-bottom: 15px;
        }
        .student-card .eng-name { font-size: 18px; font-weight: bold; }
        .student-card .country { font-size: 14px; color: #666; margin-bottom: 20px; }
        .student-details { width: 100%; font-size: 14px; }
        .student-details .detail-row { display: grid; grid-template-columns: 100px 1fr; margin-bottom: 8px; }
        .student-details .detail-row span:first-child { font-weight: bold; color: #555; }
        .student-card textarea {
            width: calc(100% - 22px); height: 60px; margin-top: 20px; padding: 10px;
            border-radius: 4px; border: 1px solid #CCC; resize: vertical;
        }
        .student-card .action-buttons { display: flex; justify-content: space-between; width: 100%; margin-top: 15px; }
        .btn-action { width: 48%; padding: 10px; }
        .btn-approve { background-color: #4CAF50; color: white; }
        .btn-disapprove { background-color: #F44336; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>ODOS Student Management System</h1>
            <p>Department of Digital Economy Promotion (depa)</p>
        </div>

        <div class="card">
            <div class="search-students">
                <div class="form-group">
                    <label for="studentId">Student ID:</label>
                    <input type="text" id="studentId" placeholder="Enter Student ID">
                </div>
                <div class="form-group">
                    <label for="thaiName">Thai Name:</label>
                    <input type="text" id="thaiName" placeholder="Enter Thai Name">
                </div>
                <div class="form-group">
                    <label for="englishName">English Name:</label>
                    <input type="text" id="englishName" placeholder="Enter English Name">
                </div>
                <div class="button-group">
                    <button class="btn btn-add">Search ID</button> 
                    <button class="btn btn-clear" onclick="clearAll()">Clear All</button>
                </div>
            </div>
        </div>
        
        <button class="btn btn-approve-all">Approve All</button>
        <div style="clear: both;"></div>

        <div class="loading" id="loading" style="display: none;">Searching...</div>
        
        <div id="studentListContainer" class="student-list-container"></div>
    </div>

    <template id="studentCardTemplate">
        <div class="student-card-wrapper">
            <div class="student-card">
                <div class="profile-pic">
                    <img class="profile-image" src="" alt="Profile Picture">
                </div>
                <div class="eng-name"></div>
                <div class="country"></div>

                <div class="student-details">
                    <div class="detail-row"><span>ID:</span><span class="info-id"></span></div>
                    <div class="detail-row"><span>Thai Name:</span><span class="info-thai-name"></span></div>
                    <div class="detail-row"><span>Birth Date:</span><span class="info-birth-date"></span></div>
                    <div class="detail-row"><span>Age:</span><span class="info-age"></span></div>
                    <div class="detail-row"><span>Province:</span><span class="info-province"></span></div>
                    <div class="detail-row"><span>GPA:</span><span class="info-gpa"></span></div>
                    <div class="detail-row"><span>EnglishGPA:</span><span class="info-EnglishGPA"></span></div>
                    <div class="detail-row"><span>Study Status:</span><span class="info-study-status"></span></div>
                </div>

                <textarea class="comments-textarea" placeholder="Add your comments here"></textarea>
                <div class="action-buttons">
                    <button class="btn btn-action btn-approve">Approve</button>
                    <button class="btn btn-action btn-disapprove">Disapprove</button>
                </div>
            </div>
        </div>
    </template>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzN_q1RzHFRI6Li0emdBG6oQ9YBtZ_ADyEDwwVFIrTagg0206BzdblhJwKiBwSvMeTrsg/exec"; // <-- ใส่ URL ของคุณ

        const studentIdInput = document.getElementById('studentId');
        const thaiNameInput = document.getElementById('thaiName');
        const englishNameInput = document.getElementById('englishName');
        const loadingDiv = document.getElementById('loading');
        const studentListContainer = document.getElementById('studentListContainer');
        const searchIdBtn = document.querySelector('.btn-add'); // เปลี่ยนชื่อตัวแปรให้สื่อความหมาย

        // ทำให้ปุ่ม Search ID ทำงาน
        searchIdBtn.addEventListener('click', () => {
            const studentIdValue = studentIdInput.value;
            if (studentIdValue) {
                searchStudent('studentID', studentIdValue);
            } else {
                alert('Please enter a Student ID to search.');
            }
        });

        // ทำให้การกด Enter ทำงาน
        studentIdInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchStudent('studentID', e.target.value); });
        thaiNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchStudent('thaiName', e.target.value); });
        englishNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchStudent('englishName', e.target.value); });

        function searchStudent(key, value) {
            if (!value) return;
            loadingDiv.style.display = 'block';
            studentListContainer.innerHTML = '';
            disableSearchInputs(true);

            fetch(`${SCRIPT_URL}?key=${key}&value=${encodeURIComponent(value)}`)
                .then(response => response.json())
                .then(res => {
                    displayStudentList(res.data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    studentListContainer.innerHTML = '<div class="message">An error occurred while searching.</div>';
                })
                .finally(() => {
                    loadingDiv.style.display = 'none';
                    disableSearchInputs(false);
                });
        }

        function displayStudentList(students) {
            const template = document.getElementById('studentCardTemplate');
            studentListContainer.innerHTML = '';

            if (!students || students.length === 0) {
                studentListContainer.innerHTML = '<div class="message">Student not found.</div>';
                return;
            }

            const studentsToShow = students.slice(0, 5);

            studentsToShow.forEach(student => {
                const card = template.content.cloneNode(true);
                
                card.querySelector('.profile-image').src = student['Image'] || 'https://via.placeholder.com/100';
                card.querySelector('.eng-name').textContent = `${student['English Firstname']} ${student['English Lastname']}`;
                card.querySelector('.country').textContent = student['Country'];
                card.querySelector('.info-id').textContent = student['ID'];
                card.querySelector('.info-thai-name').textContent = `${student['Thai Firstname']} ${student['Thai Lastname']}`;
                
                const birthDateStr = student['Date of Birth'];
                if (birthDateStr) {
                    const dateParts = birthDateStr.split('/');
                    if (dateParts.length === 3) {
                        const birthDate = new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0]);
                        card.querySelector('.info-birth-date').textContent = birthDate.toLocaleDateString('en-GB');
                        const birthYear = birthDate.getFullYear();
                        if (!isNaN(birthYear)) {
                            card.querySelector('.info-age').textContent = `${2025 - birthYear} years`;
                        }
                    } else {
                         card.querySelector('.info-birth-date').textContent = 'Invalid Date';
                         card.querySelector('.info-age').textContent = 'N/A';
                    }
                }
                
                card.querySelector('.info-province').textContent = student['จังหวัดตามทะเบียนบ้าน'];
                card.querySelector('.info-gpa').textContent = student['เกรดเฉลี่ยภาคการศึกษาก่อนหน้า (GPA)'];
                card.querySelector('.info-EnglishGPA').textContent = student['เกรดวิชาภาษาอังกฤษเทอมก่อนหน้า'];
                card.querySelector('.info-study-status').textContent = student['อยู่ระหว่างการศึกษา'];

                const studentId = student['ID'];
                const approveBtn = card.querySelector('.btn-approve');
                const disapproveBtn = card.querySelector('.btn-disapprove');
                const commentsTextarea = card.querySelector('.comments-textarea');

                approveBtn.addEventListener('click', () => submitDecision(studentId, 'Approve', commentsTextarea.value, approveBtn, disapproveBtn));
                disapproveBtn.addEventListener('click', () => submitDecision(studentId, 'Disapprove', commentsTextarea.value, approveBtn, disapproveBtn));

                studentListContainer.appendChild(card);
            });
        }

        function submitDecision(studentID, status, comment, approveBtn, disapproveBtn) {
            const dataToPost = {
                studentID: studentID,
                comment: comment,
                status: status
            };
            approveBtn.disabled = true;
            disapproveBtn.disabled = true;

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(dataToPost)
            })
            .then(() => alert(`Student ID ${studentID} status set to '${status}'.`))
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred.');
                approveBtn.disabled = false;
                disapproveBtn.disabled = false;
            });
        }

        function clearAll() {
            studentIdInput.value = '';
            thaiNameInput.value = '';
            englishNameInput.value = '';
            studentListContainer.innerHTML = '';
        }

        function disableSearchInputs(disabled) {
            studentIdInput.disabled = disabled;
            thaiNameInput.disabled = disabled;
            englishNameInput.disabled = disabled;
        }
    </script>
</body>
</html>